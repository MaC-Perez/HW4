---
title: "Edwards-Perez-Whelpley-HW4"
output:
  pdf_document: default
  html_document: default
  word_document: default
date: "2022/11/03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,  include=FALSE}
library(Rpath)
library(data.table)
#devtools::install_github('NOAA-EDAB/Rpath', build_vignettes = TRUE)
library(devtools)
library(ggplot2)
```

**Anchovy Bay: an imaginary ecosystem model**
\vspace{10pt}

The bay covers an area of 100 km2 and is rather isolated from other marine systems, and we can assume that the populations stay in the bay year-round. Our model will have the following 16 groups. The first 10 are living: whales, seals, cod, whiting, mackerel, anchovy, shrimp, benthos, zooplankton, and phytoplankton. There is one detrital group called detritus. In addition, there are 5 fleets: sealers, trawlers, seiners, bait boats, and shrimpers

\vspace{10pt}
**Building the parameter file for Rpath:**
\vspace{10pt}

```{r,  include=FALSE}
groups <- c('whales', 'seals', 'cod', 'whiting', 'mackerel', 'anchovy', 'shrimp',
            'benthos', 'zooplankton', 'phytoplankton', 'detritus', 'sealers', 
            'trawlers', 'seiners', 'bait boats', 'shrimpers')

types <- c(rep(0, 9), 1, 2, rep(3, 5))

AB.params <- create.rpath.params(groups, types)
```

**Fisheries Data:**
\vspace{10pt}

The sealers caught 15 seals with an average weight of 30kg. The fisheries catches were 45t of cod and 20t of whiting for the trawlers, 40t of mackerel and 120t of anchovy for the seiners, 20t of anchovy for the bait boats, and 5t of shrimp for the shrimpers. Calculate catches using the appropriate unit (t/km2/year), and enter in Rpath.

*Static parameters for this example:*
Biomass accumulation and un-assimilated production
\vspace{10pt}

```{r,  include=FALSE}
AB.params$model[Group=="seals", sealers:=0.0045] 
AB.params$model[Group=="cod", trawlers:=0.45]
AB.params$model[Group=="whiting", trawlers:=0.20]
AB.params$model[Group=="mackerel", seiners:=0.40]
AB.params$model[Group=="anchovy", seiners:=1.20]
AB.params$model[Group=="anchovy", "bait boats":=0.20]
AB.params$model[Group=="shrimp", shrimpers:=0.05]
```

**Biological Data:** 
\vspace{10pt}

```{r,  include=FALSE}
AB.params$model[Group=="whales", Biomass:=0.08] 
AB.params$model[Group=="seals", Biomass:=0.0609]
AB.params$model[Group=="cod", Biomass:=3.1]
AB.params$model[Group=="whiting", Biomass:=1.7]
AB.params$model[Group=="mackerel", Biomass:=1.22]
AB.params$model[Group=="anchovy", Biomass:=6]
AB.params$model[Group=="shrimp", Biomass:=0.8]
AB.params$model[Group=="zooplankton", Biomass:=14.8]
AB.params$model[Group=="detritus", Biomass:=10]
AB.params$model[Group=="phytoplankton", Biomass:=9]
```

P/B ratio: check!

```{r, include=FALSE}
AB.params$model[Group=="whales", PB:=0.05] 
AB.params$model[Group=="seals", PB:=0.1639]
AB.params$model[Group=="cod", PB:=0.355]
AB.params$model[Group=="whiting", PB:=0.587]
AB.params$model[Group=="mackerel", PB:=1.1478]
AB.params$model[Group=="anchovy", PB:=1.2233]
AB.params$model[Group=="shrimp", PB:=3]
AB.params$model[Group=="zooplankton", PB:=35]
AB.params$model[Group=="benthos", PB:=3]
AB.params$model[Group=="phytoplankton", PB:=240]
```

Q/B ratio: check!

```{r,  include=FALSE}
AB.params$model[Group=="whales", QB:=9]
AB.params$model[Group=="seals", QB:=15]
AB.params$model[Group=="cod", QB:=2.58]
AB.params$model[Group=="whiting", QB:=3.3]
AB.params$model[Group=="mackerel", QB:=4.4]
AB.params$model[Group=="anchovy", QB:=9.13]
```

E/E: check!

```{r,  include=FALSE}
AB.params$model[Group=="benthos", EE:=0.6]
```

```{r,  include=FALSE}
AB.params$model[Group=="shrimp", ProdCons:=0.25]
AB.params$model[Group=="benthos", ProdCons:=0.25]
AB.params$model[Group=="zooplankton", ProdCons:=0.25]
```

DIET DATA: check!
\vspace{20pt}

```{r,  include=FALSE}
AB.params$diet[Group == 'cod', whales := 0.1]
AB.params$diet[Group == 'cod', seals := 0.04]
AB.params$diet[Group == 'cod', whiting := 0.05]

AB.params$diet[Group == 'whiting', whales := 0.1]
AB.params$diet[Group == 'whiting', seals := 0.05]
AB.params$diet[Group == 'whiting', cod := 0.05]
AB.params$diet[Group == 'whiting', whiting := 0.05]

AB.params$diet[Group == 'mackerel', whales := 0.2]
AB.params$diet[Group == 'mackerel', mackerel := 0.05]

AB.params$diet[Group == 'anchovy', whales := 0.5]
AB.params$diet[Group == 'anchovy', cod := 0.10]
AB.params$diet[Group == 'anchovy', whiting := 0.45]
AB.params$diet[Group == 'anchovy', mackerel := 0.50]

AB.params$diet[Group == 'shrimp', seals := 0.01]
AB.params$diet[Group == 'shrimp', cod := 0.01]
AB.params$diet[Group == 'shrimp', whiting := 0.01]

AB.params$diet[Group == 'benthos', whales := 0.1]
AB.params$diet[Group == 'benthos', seals := 0.90]
AB.params$diet[Group == 'benthos', cod := 0.84]
AB.params$diet[Group == 'benthos', whiting := 0.44]
AB.params$diet[Group == 'benthos', shrimp := 1]
AB.params$diet[Group == 'benthos', benthos := 0.1]

AB.params$diet[Group == 'zooplankton', mackerel := .45]
AB.params$diet[Group == 'zooplankton', anchovy := 1]
AB.params$diet[Group == 'zooplankton', benthos := .1]

AB.params$diet[Group == 'phytoplankton', benthos := .1]
AB.params$diet[Group == 'phytoplankton', zooplankton := .9]

AB.params$diet[Group == 'detritus', benthos := .7]
AB.params$diet[Group == 'detritus', zooplankton := .1]
```

We now should enter the basic input parameters. Fortunately, the biologists have been busy, and we have some survey estimates of biomasses in the bay. The biomasses must be entered with the unit:t/km2. Whales: 10 individuals with an average weight of 800kg. Seals: 203 individuals with an average weight of 30kg. Cod: 310t. Whiting 170t. Mackerel: 122t. Anchovy: 600t. Shrimp: 0.8t/km2. Zooplankton: 14.8t/km2. Detritus: 10t/km2.

Next are production/biomass ratios, which with certain assumptions correspond to the total mortality, Z. The unit is year\-1, and we can often get Z from assessments. Alternatively, we have Z = F + M, so if we have the catch and the biomass, we can estimate F = C/B and add the total natural mortality to get Z. We can get estimates of M and Q/B from FishBase. Search for the species, (Gadus morhua, Merlangius merlangus, Scomber scombrus, Engraulis encrasicolus), find the life-history table, and extract the values. Estimate Z = F + M.

```{r,  include=FALSE}
AB.params$model[Type < 3, BioAcc  := 0]
AB.params$model[Type < 2, Unassim := 0.2]
AB.params$model[Type == 2, Unassim := 0]
#Detrital Fate
AB.params$model[Type < 2, detritus := 1]
AB.params$model[Type > 1, detritus := 0]
```

**Check for issues in your parameter file with**
\vspace{10pt}

```{r}
check.rpath.params(AB.params)
```

Once parameter file is built use this to run ecopath

STATUS BALANCED!

```{r, include=FALSE}
AB <- rpath(AB.params, 'Anchovy Bay')
AB
print(AB, morts = T)
webplot(AB)
```

Running Rsim: 3 step process 
Set the scene with rsim.scenario

```{r}
AB.scene <- rsim.scenario(AB, AB.params, 1:25)
```
\vspace{20pt}
**Food web plot**

```{r}
webplot(AB,
  eco.name = attr(AB, "eco.name"),  line.col = "grey",  labels = TRUE)
```

\newpage

The Production Biomass ratio (P/B) with certain assumptions correspond to the total mortality, and so the total mortality could be calculated for the remaining species to determine their PB. The total mortality (Z) was found using two methods: estimating Z using natural mortality (M) with the fishing mortality (F), and estimating Z with growth parameters using the Beverton-Holt equation.
The total mortality (Z) was calculated from the data (Z from data) using the equations: 

                                      Z=F+M and F=C/B,

where M is the natural mortality, F is the fishing mortality, C is the Catch in t/km^2, and B is the biomass in t/km^2. The natural mortality for seals was provided (M = 0.09 year\-1)). Estimates of natural mortality for cod (Gadus morhua), whiting (Merlangius merlangus), mackerel (Scomber scombrus), and anchovy (Engraulis encrasicolus) were taken from their respective life-history tables on FishBase (https://www.fishbase.se/search.php) Values of F for all species were determined using the estimates of catch and biomass of these species. Catch for each species was found by dividing the respective species fishery landings weight in tons by the area of Anchovy Bay (100 km^2). Similarly, the biomass for each species was found by dividing the respective species total survey estimate weight in tons by the area of Anchovy Bay (100 km^2). 

The total mortality (Z) was calculated from the Beverton-Holt equation (Z (B/H)) using: 

                          Z=K*((L_(inf )- L_mean ))/((L_(inf )- L')),
                          
where Lmean is the mean length of all fishes caught at sizes equal or larger than L’, which is the smallest size in the catch and here assumed to be the same as Lc, which is the mean length at entry in the fishery, assuming knife-edge selection, and thus the same as used under Yield per Recruit above.


+---------+---------+-------------+------+
| Species | Z (B&H) | Z from data | diff |
+:=======:+:=======:+:===========:+:====:+
| Cod     |  0.29   |    0.36     | -0.07|		
+---------+---------+-------------+------+		
| Whiting |  0.59   |    0.59     |  0.00|		
+---------+---------+-------------+------+		
| Mackerel|  0.63   |    1.15     | -0.51|		
+---------+---------+-------------+------+		
| Anchovy |  1.48   |    1.22     |  0.25|		
+---------+---------+-------------+------+		


The difference between the values of Z using these two different methods (diff) were examined for the fish species. Estimating Z from the data relies on estimates of catch, biomass, and natural mortality whereas estimating Z using Beverton-Holt relies on estimates of length. Estimates of Z from the data was found to be greater than those found from Beverton-Holt for cod and mackerel, while for anchovy it was lesser. For whiting, both methods resulted in the same value for Z.
\vspace{20pt}

**Exploring Ecosim with Anchovy Bay**
\vspace{10pt}
  
Scientists have noticed a gradual decline in the seal population of about 50 kg a year. The resource managers of Anchovy Bay decide that new regulations should be put in place on the seal fishery to combat this population decline. Local trawlers are concerned that an increased seal population will negatively impact their business as their chief targets are prey for seals.  

\newpage

**SCENARIOS**
\vspace{10pt}

**1) Build an rsim scenario that shows the impact of the seal decline and one that shows the impact of reducing the seal fishery in half.**
\vspace{10pt}

A decrease in fishing effort on seals will produce higher seals biomass due to less fishing pressure, producing an increase in cod biomass (we expected it to be the opposite) and a decrease in whiting biomass.

```{r}

AB.base <- rsim.scenario(AB, AB.params, 1:25)
AB.base2 <- adjust.fishing(AB.base, parameter = 'ForcedEffort', group = 'sealers',
                          sim.year = 1:25, value = 0.5)



AB.run2 <- rsim.run(AB.base2, years = 1:25)
#Output results
#AB.run2
#To capture results as an object use the write.Rsim function
AB.output <- write.Rsim(AB.run2)
```

```{r}
rsim.plot(AB.run2)
```

```{r}
seals <- extract.node(AB.run2, 'seals')
plot(seals$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Seals")

cod <- extract.node(AB.run2, 'cod')
plot(cod$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Cod")

whiting <- extract.node(AB.run2, 'whiting')
plot(whiting$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Whiting")
```

\newpage

**2) Also test the impact if seals are a strong ‘top-down’ predator. Run the simulations for 25 years.**
\vspace{10pt}

Then, seals were investigated to see what the impact would be if seals were a strong ‘top-down’ predator. To do this, we adjusted the first scenario to reflect a situation where seals had an increased effect on all of their prey.  
\vspace{10pt}

```{r, include=FALSE}
AB.base <- rsim.scenario(AB, AB.params, 1:25)
AB.base3 <- adjust.scenario(AB.base, parameter = 'VV', group = 'all', 
                           groupto = 'seals', value = 3)
```

```{r, include=FALSE}
AB.run3 <- rsim.run(AB.base3, years = 1:25)

#Output results
AB.run3
#To capture results as an object use the write.Rsim function
AB.output <- write.Rsim(AB.run3)
```

```{r}
#plot results
rsim.plot(AB.run3)
```

```{r}
seals <- extract.node(AB.run3, 'seals')
plot(seals$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Seals")

cod <- extract.node(AB.run3, 'cod')
plot(cod$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Cod")

whiting <- extract.node(AB.run3, 'whiting')
plot(whiting$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Whiting")
```
\vspace{10pt}

Several years later, ecotourism becomes a big part of Anchovy Bay. A portion of the trawlers shift their effort to taking customers whale watching. 

\newpage

**3) What is the impact on the groundfish species?** 
\vspace{10pt}

```{r, include=FALSE}
AB.base <- rsim.scenario(AB, AB.params, 1:25)
AB.base6 <- adjust.fishing(AB.base, parameter = 'ForcedEffort', group = 'trawlers',
                          sim.year = 1:25, value = 0.3)
```

```{r, include=FALSE}
AB.run6 <- rsim.run(AB.base6, years = 1:25)

#Output results
AB.run6
#To capture results as an object use the write.Rsim function
AB.output <- write.Rsim(AB.run6)
```

```{r}
#plot results
rsim.plot(AB.run6)
```

```{r}
whales <- extract.node(AB.run6, 'whales')
plot(whales$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Whales")

seals <- extract.node(AB.run6, 'seals')
plot(seals$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Seals")

cod <- extract.node(AB.run6, 'cod')
plot(cod$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Cod")

whiting <- extract.node(AB.run6, 'whiting')
plot(whiting$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Whiting")
```

\newpage

**4) What if cod are a strong ‘top-down’ predator? It has been studied that whiting will increase their consumption when at lower numbers. What effect does this have on the previous scenario?**
\vspace{10pt}

```{r, include=FALSE}
AB.base <- rsim.scenario(AB, AB.params, 1:25)
AB.base5 <- adjust.scenario(AB.base, parameter = 'VV', group = 'all', 
                           groupto = 'cod', value = 3)
```

```{r, include=FALSE}
AB.run5 <- rsim.run(AB.base5, years = 1:25)

#Output results
AB.run5
#To capture results as an object use the write.Rsim function
AB.output <- write.Rsim(AB.run5)
```

If we consider cod as top predator, its biomass increases with time and whiting biomass decreases. 

```{r}
cod <- extract.node(AB.run5, 'cod')
plot(cod$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Cod")

whiting <- extract.node(AB.run5, 'whiting')
plot(whiting$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Whiting")
```

To see whiting will increase their consumption when at lower numbers we plot the withing consumption and anchovey biomass. The effect of the whiting biomass reduction produces an increase in the consumption/biomass ratio and therefore a decrease in anchovy biomass. 

```{r}
plot(AB.run5$annual_QB[,5], main = "Whiting consumption", xlab="years", ylab="Q/B ratio")

anchovy <- extract.node(AB.run5, 'anchovy')
plot(anchovy$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Anchovy")
```

\newpage

**5) Run scenarios varying level of trawling effort. Find the effort leading to maximum long-term yield for the trawl fishery. Plot and discuss implications for species biomass, mix of species in the trawl catch, and impact on other gears associated with fishing at maximum yield for trawl.**
\vspace{10pt}

```{r, include=FALSE}
AB.base <- rsim.scenario(AB, AB.params, 1:25)
AB.base6 <- adjust.fishing(AB.base, parameter = 'ForcedEffort', group = 'trawlers',
                          sim.year = 1:25, value = 0.3)
```

```{r, include=FALSE}
AB.run6 <- rsim.run(AB.base6, years = 1:25)

#Output results
AB.run6
#To capture results as an object use the write.Rsim function
AB.output <- write.Rsim(AB.run6)
```

```{r}
#plot results
rsim.plot(AB.run6)
```

```{r}
whales <- extract.node(AB.run6, 'whales')
plot(whales$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Whales")

seals <- extract.node(AB.run6, 'seals')
plot(seals$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Seals")

cod <- extract.node(AB.run6, 'cod')
plot(cod$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Cod")

whiting <- extract.node(AB.run6, 'whiting')
plot(whiting$Biomass, xlab = 'Month', ylab = 'Biomass', main = "Whiting")
```

\newpage

Finally, develop two or more strategies to test in an MSE framework within Anchovy Bay. The management objective is to maximize fishery yield but not allowing any species to go below 1/2 BMSY. 
\vspace{10pt}

**6) Show tradeoffs between fisheries. Assuming that cod sells for $3/pound, mackerel $2/pound, whiting $1/pound, shrimp $4/pound, and anchovies $0.50/pound is one of your strategies more economically beneficial to the community? The AB_closed_loop.R script can help you set-up the closed loop simulation.**

\vspace{10pt}




