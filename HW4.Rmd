---
title: "Edwards-Perez-Whelpley-HW4"
output: html_document
date: "2022-10-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,  include=FALSE}
library(Rpath)
library(data.table)
#devtools::install_github('NOAA-EDAB/Rpath', build_vignettes = TRUE)
library(devtools)
```

**Anchovy Bay: an imaginary ecosystem model**

The bay covers an area of 100 km2 and is rather isolated from other marine systems, and we can assume that the populations stay in the bay year-round. Our model will have the following 16 groups. The first 10 are living: whales, seals, cod, whiting, mackerel, anchovy, shrimp, benthos, zooplankton, and phytoplankton. There is one detrital group called detritus. In addition, there are 5 fleets: sealers, trawlers, seiners, bait boats, and shrimpers

Building the parameter file for Rpath:

```{r,  include=FALSE}
groups <- c('whales', 'seals', 'cod', 'whiting', 'mackerel', 'anchovy', 'shrimp',
            'benthos', 'zooplankton', 'phytoplankton', 'detritus', 'sealers', 
            'trawlers', 'seiners', 'bait boats', 'shrimpers')

types <- c(rep(0, 9), 1, 2, rep(3, 5))

AB.params <- create.rpath.params(groups, types)
```

**Fisheries Data:**

The sealers caught 15 seals with an average weight of 30kg. The fisheries catches were 45t of cod and 20t of whiting for the trawlers, 40t of mackerel and 120t of anchovy for the seiners, 20t of anchovy for the bait boats, and 5t of shrimp for the shrimpers. Calculate catches using the appropriate unit (t/km2/year), and enter in Rpath.

*Static parameters for this example:*
Biomass accumulation and un-assimilated production

```{r,  include=FALSE}
AB.params$model[Group=="seals", sealers:=0.0045] 
AB.params$model[Group=="cod", trawlers:=0.45]
AB.params$model[Group=="whiting", trawlers:=0.20]
AB.params$model[Group=="mackerel", seiners:=0.40]
AB.params$model[Group=="anchovy", seiners:=1.20]
AB.params$model[Group=="anchovy", "bait boats":=0.20]
AB.params$model[Group=="shrimp", shrimpers:=0.05]
```

**Biological Data:** 

```{r,  include=FALSE}
AB.params$model[Group=="whales", Biomass:=0.08] 
AB.params$model[Group=="seals", Biomass:=0.0609]
AB.params$model[Group=="cod", Biomass:=3.1]
AB.params$model[Group=="whiting", Biomass:=1.7]
AB.params$model[Group=="mackerel", Biomass:=1.22]
AB.params$model[Group=="anchovy", Biomass:=6]
AB.params$model[Group=="shrimp", Biomass:=0.8]
AB.params$model[Group=="zooplankton", Biomass:=14.8]
AB.params$model[Group=="detritus", Biomass:=10]
AB.params$model[Group=="phytoplankton", Biomass:=9]
```

P/B ratio: check!

```{r, include=FALSE}
AB.params$model[Group=="whales", PB:=0.05] 
AB.params$model[Group=="seals", PB:=0.1639]
AB.params$model[Group=="cod", PB:=0.355]
AB.params$model[Group=="whiting", PB:=0.587]
AB.params$model[Group=="mackerel", PB:=1.1478]
AB.params$model[Group=="anchovy", PB:=1.2233]
AB.params$model[Group=="shrimp", PB:=3]
AB.params$model[Group=="zooplankton", PB:=35]
AB.params$model[Group=="benthos", PB:=3]
AB.params$model[Group=="phytoplankton", PB:=240]
```

Q/B ratio: check!

```{r,  include=FALSE}
AB.params$model[Group=="whales", QB:=9]
AB.params$model[Group=="seals", QB:=15]
AB.params$model[Group=="cod", QB:=2.58]
AB.params$model[Group=="whiting", QB:=3.3]
AB.params$model[Group=="mackerel", QB:=4.4]
AB.params$model[Group=="anchovy", QB:=9.13]
```

E/E: check!

```{r,  include=FALSE}
AB.params$model[Group=="benthos", EE:=0.6]
```

```{r,  include=FALSE}
AB.params$model[Group=="shrimp", ProdCons:=0.25]
#AB.params$model[Group=="benthos", ProdCons:=0.25]
#AB.params$model[Group=="zooplankton", ProdCons:=0.25]
```

We now should enter the basic input parameters. Fortunately, the biologists have been busy, and we have some survey estimates of biomasses in the bay. The biomasses must be entered with the unit:t/km2. Whales: 10 individuals with an average weight of 800kg. Seals: 203 individuals with an average weight of 30kg. Cod: 310t. Whiting 170t. Mackerel: 122t. Anchovy: 600t. Shrimp: 0.8t/km2. Zooplankton: 14.8t/km2. Detritus: 10t/km2.

Next are production/biomass ratios, which with certain assumptions correspond to the total mortality, Z. The unit is year−1, and we can often get Z from assessments. Alternatively, we have Z = F + M, so if we have the catch and the biomass, we can estimate F = C/B and add the total natural mortality to get Z. We can get estimates of M and Q/B from FishBase. Search for the species, (Gadus morhua, Merlangius merlangus, Scomber scombrus, Engraulis encrasicolus), find the life-history table, and extract the values. Estimate Z = F + M.

```{r,  include=FALSE}
AB.params$model[Type < 3, BioAcc  := 0]
AB.params$model[Type < 2, Unassim := 0.2]
AB.params$model[Type == 2, Unassim := 0]
#Detrital Fate
AB.params$model[Type < 2, detritus := 1]
AB.params$model[Type > 1, detritus := 0]
```

It is also an option for exploited species to use an equation for estimation of Z that was developed by Beverton and Holt (1957). It is implemented in the life-history table in FishBase. It relies on estimates of length at first capture (Lc), average length in the catch (Lmean), and asymptotic length (Linf) to estimate Z. Try it for the four fish species in our model. Here are the lengths from the fishery in Anchovy Bay:

+---------+---------+-------------+------+
| Species | Z (B&H) | Z from data | diff |
+:=======:+:=======:+:===========:+:====:+
| Cod     |  0.29   |    0.36     | -0.07|		
+---------+---------+-------------+------+		
| Whiting |  0.59   |    0.59     |  0.00|		
+---------+---------+-------------+------+		
| Mackerel|  0.63   |    1.15     | -0.51|		
+---------+---------+-------------+------+		
| Anchovy |  1.48   |    1.22     |  0.25|		
+---------+---------+-------------+------+		

There is a close relationship between size and P/B; the bigger animals are, the lower the P/B. Here we have: Whales: P/B = 0.05year−1; seals: get F from catch, and M is 0.09year−1; shrimp P/B = 3year−1; benthos P/B = 3year−1; zooplankton: it is mainly small Acartia-sized plankton, with P/B = 35year−1.

We can get P/B for many invertebrates from Tom Brey’s work (but don’t need to for this tutorial). Check out: http://www.thomas-brey.de/science/virtualhandbook/. There is a neat collection of empirical relationships and conversion factors.


Check for issues in your parameter file with

```{r, include=FALSE}
check.rpath.params(AB.params)
```

Once parameter file is built use this to run ecopath

STATUS BALANCED!

```{r}
AB <- rpath(AB.params, 'Anchovy Bay')
AB
print(AB, morts = T)
webplot(AB)
```

Running Rsim: 3 step process 
Set the scene with rsim.scenario

```{r}
AB.scene <- rsim.scenario(AB, AB.params, 1:25)
```

Make any adjustments

```{r}
AB.scene <- adjust.fishing(AB.scene, 'ForcedEffort', group = 'sealers',
                           sim.year = 10:25, value = 0.5)
```

Run the scenario

```{r}
AB.run <- rsim.run(AB.scene, years = 1:25)
```


**Food web plot**

```{r}
webplot(AB,
  eco.name = attr(AB, "eco.name"),
  line.col = "grey",
  highlight = NULL,
  highlight.col = c("black", "red", "orange"),
  labels = FALSE,
  label.pos = NULL,
  label.num = FALSE,
  label.cex = 1,
  fleets = FALSE,
  type.col = "black",
  box.order = NULL
)
```

**Exploring Ecosim with Anchovy Bay**

Scientists have noticed a gradual decline in the seal population of about 50 kg a year. The resource managers of Anchovy Bay decide that new regulations should be put in place on the seal fishery to combat this population decline. Local trawlers are concerned that an increased seal population will negatively impact their business as their chief targets are prey for seals. Build an rsim scenario that shows the impact of the seal decline and one that shows the impact of reducing the seal fishery in half. Also test the impact if seals are a strong ‘top-down’ predator. Run the simulations for 25 years.

Several years later, ecotourism becomes a big part of Anchovy Bay. A portion of the trawlers shift their effort to taking customers whale watching. What is the impact on the groundfish species? What if cod are a strong ‘top-down’ predator? It has been studied that whiting will increase their consumption when at lower numbers. What effect does this have on the previous scenario?

Scenarios can be viewed as a table or as a graph. The built in function in Rpath for graphing the results is rsim.plot. Play around with whatever other scenario you can think up.

Run scenarios varying level of trawling effort. Find the effort leading to maximum long-term yield for the trawl fishery. Plot and discuss implications for species biomass, mix of species in the trawl catch, and impact on other gears associated with fishing at maximum yield for trawl.

Finally, develop two or more strategies to test in an MSE framework within Anchovy Bay. The management objective is to maximize fishery yield but not allowing any species to go below 1/2 BMSY. Show tradeoffs between fisheries. Assuming that cod sells for $3/pound, mackerel $2/pound, whiting $1/pound, shrimp $4/pound, and anchovies $0.50/pound is one of your strategies more economically beneficial to the community? The AB_closed_loop.R script can help you set-up the closed loop simulation.

